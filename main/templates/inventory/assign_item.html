{% extends "base.html" %}
{% load custom_filters %}
{% block content %}
<div class="container mt-4" style="margin-bottom:200px;">
  <div class="card text-white" style="background-color: #5bc0de; /* Custom color between sky blue and blue */">
    <div class="card-body text-center">
      <h2 class="card-title">ASSIGN ITEM</h2>
    </div>
  </div>
  <div style="margin-bottom: 20px;"></div>
  <div class="input-group mb-3 search-input-group">
    <input type="text" id="searchInput" class="form-control search-input" placeholder="Type to Search">
    <div class="input-group-append">
      <span class="input-group-text search-icon">
        <i class="fas fa-search"></i>
      </span>
    </div>
  </div>
  <style>
    .thead-custom {
      background-color: #343a40; /* Dark background color */
      color: #ffffff; /* Text color */
      font-weight: bold; /* Bold text */
    }
  
    .thead-custom th {
      border: 1px solid #454d55; /* Border color */
      padding: 10px; /* Adjust padding as needed */
    }
  </style>
  <div class="table-responsive">
    <form method="post" action="" id="assignForm">
      {% csrf_token %}
      <table class="table table-striped table-bordered table-hover">
        <!-- Table header -->
        <thead class="thead-custom">
          <tr>
            <th>Select</th>
            <th>Name</th>
            <th>Description</th>
            <th>Consumable</th>
            <th>Available Quantity</th>
            <th>Selected Quantity</th>
            <th>Condition</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            {% if item.assignedOffice != user_subgroup_name and item.quantity > 0 %}

          
            {% comment %} {% if item.assignedOffice != user_subgroup_name and item.quantity > 0 and  item.consumable == 'Non-Consumable' %} {% endcomment %}

            {% comment %} {% if item.assignedOffice|lower == 'store' and item.quantity > 0 %} {% endcomment %}
              <!-- Table rows for items -->
              <tr class="table-row" data-item-id="{{ item.pk }}">
                <td>
                  <input type="checkbox" name="selected_items" value="{{ item.pk }}" class="form-check-input">
                </td>
                <td class="primary-key" data-primary-key="{{ item.pk }}">{{ item.name }}</td>
                <td>{{ item.description }} {% if item.consumable == 'Non-Consumable' %}({{ item.jinsi_no }}){% endif %}</td>
                <td>{{ item.consumable }}</td>
                <td>{{ item.quantity }} {{item.unit}}</td>
                <td>
                  <input type="number" name="selected_quantity_{{ item.pk }}" class="form-control selected-quantity" min="0" max="{{ item.quantity }}">
                </td>
                <td>{{ item.get_condition_display }}</td>
              </tr>
            {% endif %}
          {% endfor %}
        </tbody>
      </table>


      <!-- Your existing template code -->
      <div class="available-groups">
        {% for subgroup in available_subgroups %}
            <button type="submit" name="assigned_to" value="{{ subgroup }}" class="btn btn-primary group-button">{{ subgroup }}</button>
        {% endfor %}
    </div>
    



      <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
              {% comment %} <button type="button" class="close" data-dismiss="modal" aria-label="Close"> {% endcomment %}
                {% comment %} <span aria-hidden="true">&times;</span> {% endcomment %}
              </button>
            </div>
            <div class="modal-body" id="confirmationMessage"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirmActionButton">OK</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const assignForm = document.getElementById('assignForm');
    const groupButtons = document.querySelectorAll('.group-button');
    const tableRows = document.querySelectorAll('.table-row');
    const confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmationMessage = document.getElementById('confirmationMessage');
    const confirmActionButton = document.getElementById('confirmActionButton');
  
    function handleFormSubmission(buttonValue) {
      const selectedItems = document.querySelectorAll('input[name="selected_items"]:checked');
      const selectedQuantityInputs = document.querySelectorAll('.selected-quantity');

      // Ensure there is at least one selected item
      if (selectedItems.length === 0) {
        alert('Please select at least one item.');
        return;
      }

      // Build an object to store selected quantities
      const selectedQuantities = {};
      selectedQuantityInputs.forEach(input => {
        const itemId = input.getAttribute('name').replace('selected_quantity_', '');
        selectedQuantities[itemId] = input.value;
      });

      // Add selected quantities to the form data
      for (const [itemId, quantity] of Object.entries(selectedQuantities)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = `selected_quantity_${itemId}`;
        input.value = quantity;
        assignForm.appendChild(input);
      }

      // Add the assigned office to the form data
      const assignedToInput = document.createElement('input');
      assignedToInput.type = 'hidden';
      assignedToInput.name = 'assigned_to';
      assignedToInput.value = buttonValue;
      assignForm.appendChild(assignedToInput);

      // Display the confirmation modal
      const itemNames = Array.from(selectedItems).map(item => item.closest('.table-row').querySelector('.primary-key').textContent.trim());
      const itemNamesText = itemNames.length === 1 ? itemNames[0] : itemNames.slice(0, -1).join(', ') + ' and ' + itemNames.slice(-1);
  
      let itemDetails = '';
      selectedItems.forEach(item => {
          const row = item.closest('.table-row');
          const itemName = row.querySelector('.primary-key').textContent.trim();
          const itemQuantity = row.querySelector('.selected-quantity').value;
          itemDetails += `${itemQuantity} ${itemName}, `;
      });
      itemDetails = itemDetails.slice(0, -2); // Remove the trailing comma and space
      
      confirmationMessage.textContent = `Are you sure to assign ${selectedItems.length} item(s) (${itemDetails}) to ${buttonValue}?`;
      
   //   confirmationMessage.textContent = `Are you sure to assign ${selectedItems.length} item(s) (${itemNamesText}) to ${buttonValue}?`;
      confirmActionButton.onclick = function () {
        confirmationModal.hide();
        assignForm.submit(); // Submit the form if OK is clicked
      };
  
      document.querySelector('.btn-secondary').addEventListener('click', function (event) {
        event.preventDefault();
        confirmationModal.hide();
      });
  
      confirmationModal.show();
    }
  
    groupButtons.forEach(function (button) {
      button.addEventListener('click', function (event) {
        // Prevent the default form submission behavior
        event.preventDefault();
        // Handle the form submission with confirmation
        handleFormSubmission(button.value);
      });
    });
  
    tableRows.forEach(function (row) {
      row.addEventListener('click', function (event) {
        const checkbox = row.querySelector('input[name="selected_items"]');
        const selectedQuantityInput = row.querySelector('.selected-quantity');
  
        // Check if the clicked element is the "Selected Quantity" input
        if (event.target === selectedQuantityInput) {
          event.preventDefault();
        } else {
          checkbox.checked = !checkbox.checked;
          if (checkbox.checked) {
            selectedQuantityInput.value = 1;
          }
        }
      });
    });
  });
</script>



{% endblock %}
